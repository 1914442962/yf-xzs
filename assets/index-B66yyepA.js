import{A as e,B as t,cE as n,b as a,r as o,o as i,c as r,d as s,e as l,w as d,i as c,x as f,F as h,v as p,f as u,z as g}from"./index-CRHEuOwk.js";import"./polyfill-lGe4XDVY.js";let m=t.base;const b={loadDataService:t=>e({url:"".concat(m,"/first/queryAllFst"),method:"post",data:t,showLoading:!0}),seletNormalDiagramList:t=>e({url:"".concat(m,"/NormalDiagramController/seletNormalDiagramList"),method:"post",data:t,showLoading:!0}),queryInitFstService:t=>e({url:"".concat(m,"/first/queryInitFst"),method:"post",data:t,showLoading:!0}),saveDataService:t=>e({url:"".concat(m,"/first/saveFst"),method:"post",data:t,showLoading:!0}),setCurrentService:t=>e({url:"".concat(m,"/first/changeFst"),method:"post",data:t,showLoading:!0})};function x(e){e.find(".textGroup").forEach(t=>{t.off("dblclick dbltap"),t.on("dblclick dbltap",n=>{const a=t.findOne(".textBody");if(!a)return;const o=document.getElementById("text-editor-save-btn");o&&o.click(),function(t){const n=t.getParent(),a=n?n.findOne(".textBackground"):null,o=t.text(),i=a?a.height():0,r=t.height(),s=i-r,l=s>0?s:4;if(document.getElementById("text-edit-modal-dynamic"))return;const d=document.createElement("div");d.id="text-edit-modal-dynamic",d.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); border: 1px solid #ddd; z-index: 10000;";const c=document.createElement("textarea");c.value=o,c.style.cssText="width: 320px; height: 140px; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; line-height: 1.2; display: block; outline: none;";const f=document.createElement("button");f.innerText="完成",f.id="text-editor-save-btn",f.style.cssText="padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; float: right;";const h=document.createElement("button");h.innerText="取消",h.style.cssText="padding: 8px 15px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; float: right; margin-right: 10px;",d.appendChild(c),d.appendChild(f),d.appendChild(h),document.body.appendChild(d),c.addEventListener("input",()=>{const n=c.value;if(t.text(n),a){const e=a.width();t.setAttrs({width:e,wrap:"word"}),t.getSelfRect();const n=t.height()+l;a.height(Math.max(n,i))}e.batchDraw()}),f.onclick=()=>{d.parentNode&&d.parentNode.removeChild(d),t.listening(!0),n&&n.listening(!0)},h.onclick=()=>{t.text(o),a&&a.height(i),e.batchDraw(),d.parentNode&&d.parentNode.removeChild(d),t.listening(!0),n&&n.listening(!0)},c.addEventListener("keydown",e=>{"Enter"===e.key&&e.ctrlKey?(e.preventDefault(),f.click()):"Escape"===e.key&&h.click()}),t.listening(!1),n&&n.listening(!1),c.focus(),c.select()}(a),n.cancelBubble=!0})})}const y={};function w(e){var t;let n=0,a=0,o=0,i=1,r=1,s=e;for(;s&&"BODY"!==s.tagName;){const e=s.getAttribute("transform");if(e){const t=e.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);t&&(n+=parseFloat(t[1])*i,a+=parseFloat(t[2])*r);const s=e.match(/matrix\(([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)\)/);if(s){const e=parseFloat(s[1]),t=parseFloat(s[4]);n+=parseFloat(s[5])*i,a+=parseFloat(s[6])*r,i*=e,r*=t}const l=e.match(/rotate\(([^)]+)\)/);l&&(o+=parseFloat(l[1]))}if("svg"===s.tagName&&(n+=parseFloat(s.getAttribute("x")||0)*i,a+=parseFloat(s.getAttribute("y")||0)*r),s=s.parentElement,!s||"svg"===s.tagName&&"g"!==(null==(t=s.parentElement)?void 0:t.tagName))break}return"text"===e.tagName&&(n+=parseFloat(e.getAttribute("x")||0)*i,a+=parseFloat(e.getAttribute("y")||0)*r),{absX:n,absY:a,absRotation:o,absScaleX:i,absScaleY:r}}const v={"drag-text":{label:"拖拽文本",create:e=>{const t=new n.Group({x:e.x,y:e.y,draggable:!0,name:"textGroup"}),a=new n.Rect({width:80,height:25,fill:"#ffffff",stroke:"#000000",strokeWidth:1,name:"textBackground"}),o=new n.Text({x:0,y:6,width:80,text:"新节点",fontSize:12,fontFamily:"黑体",align:"center",fontWeight:"bold",fill:"#000000",name:"textBody"});return t.add(a,o),t}},"breaker-node":{label:"开关节点",create:e=>{const t=new n.Group({x:e.x,y:e.y,draggable:!0,name:"breakerGroup"}),a=new n.Rect({width:40,height:20,fill:"#ffffff",stroke:"#ff0000",strokeWidth:2,name:"nodeBody"});return t.add(a),t}}};function k(e){const t="konva-dynamic-context-menu",a=".globalTransformer";let o=document.getElementById(t);o||(o=document.createElement("div"),o.id=t,o.style.cssText="\n      position: fixed; display: none; width: 150px; background: #2b2b2b;\n      border: 1px solid #444; border-radius: 4px; flex-direction: column;\n      padding: 5px 0; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n      font-family: Arial, sans-serif; color: #eee; font-size: 13px; cursor: default;\n    ",document.body.appendChild(o));let i=[];e.on("contextmenu",t=>{var r;t.evt.preventDefault();const s=e.findOne(a),l=s?s.nodes():[];let d=null,c=t.target;for(;c&&c!==e;){if(c instanceof n.Group&&(null==(r=c.name())?void 0:r.toLowerCase().includes("group"))){d=c;break}c=c.getParent()}const f=t.target.getParent()instanceof n.Transformer;d||f?(i=l.includes(d)?l:d?[d]:[],(()=>{o.innerHTML="";const t=document.createElement("div");if(t.style.cssText="display:flex; align-items:center; padding: 8px 12px; border-bottom: 1px solid #333; cursor: pointer;",t.innerHTML='<span style="flex:1">修改颜色</span><input type="color" id="picker-inner" style="width:24px; height:24px; border:none; background:none; cursor:pointer;">',t.querySelector("input").oninput=t=>{const n=t.target.value;i.forEach(e=>{e.find("Text, Line, Rect, Circle, Path").forEach(e=>{"Text"===e.getClassName()||e.hasFill()&&!["transparent","white","#ffffff"].includes(e.fill())?e.fill(n):e.stroke(n)})}),e.batchDraw()},o.appendChild(t),i.some(e=>e.findOne(".wireBody")||e.findOne("Line"))){const t=document.createElement("div");t.innerText="切换虚线",t.style.cssText="padding: 8px 12px; cursor: pointer;",t.onclick=t=>{t.stopPropagation(),i.forEach(e=>{const t=e.findOne(".wireBody")||e.findOne("Line");if(t){const e=t.dash()&&t.dash().length>0;t.dash(e?[]:[10,5])}}),e.batchDraw(),o.style.display="none"},t.onmouseenter=()=>t.style.background="#3e95ff",t.onmouseleave=()=>t.style.background="transparent",o.appendChild(t)}const n=document.createElement("div");n.innerText="删除选中",n.style.cssText="padding: 8px 12px; cursor: pointer; color: #ff5555;",n.onclick=t=>{t.stopPropagation(),i.forEach(e=>e.destroy());const n=e.findOne(a);n&&n.nodes([]),e.batchDraw(),o.style.display="none"},n.onmouseenter=()=>n.style.background="#3e95ff",n.onmouseleave=()=>n.style.background="transparent",o.appendChild(n)})(),o.style.display="flex",o.style.left=t.evt.clientX+"px",o.style.top=t.evt.clientY+"px"):o.style.display="none"}),window.addEventListener("click",()=>{o.style.display="none"})}function C(e,t){!function(e){const t=e.querySelector("style");if(t){const e=t.textContent,n=/\.([a-zA-Z0-9_-]+)\s*\{([^}]+)\}/g;let a;for(;null!==(a=n.exec(e));){const e=a[1],t=a[2].split(";").reduce((e,t)=>{const[n,a]=t.split(":");return n&&a&&(e[n.trim()]=a.trim()),e},{});y[e]=t}}}(t),function(e,t){let a=e.findOne("#lineLayer")||new n.Layer({id:"lineLayer",name:"lineLayer"});e.findOne("#lineLayer")||e.add(a),t.querySelectorAll("path").forEach(t=>{if(t.closest("switch")||t.closest("foreignObject"))return;const o=t.closest("g");if(o&&o.querySelector("text"))return;const i=t.getAttribute("d");if(!i)return;const{absX:r,absY:s,absRotation:l,absScaleX:d,absScaleY:c}=w(t),f=t.getAttribute("class"),h=y[f]||{},p=new n.Group({x:r,y:s,rotation:l,scaleX:d,scaleY:c,name:"lineGroup",id:"lineGroup-".concat(o?o.id:Math.random().toString(36).substr(2,9))}),u=(h.stroke||"").toLowerCase(),g=u&&"none"!==u,m=(h.fill||"").toLowerCase(),b=m&&"none"!==m,x=i.trim().toLowerCase().endsWith("z"),v={x:0,y:0,stroke:g?u:void 0,strokeEnabled:g,strokeWidth:g?parseFloat(h["stroke-width"])||1:0,fill:b?m:x?"white":void 0,fillEnabled:b||x,lineCap:"round",lineJoin:"round",dash:h["stroke-dasharray"]?h["stroke-dasharray"].split(/[, ]+/).map(Number):null,name:"wireBody"};let k;if(h["marker-end"]||t.getAttribute("marker-end")){const e=i.replace(/[MLZz]/g," ").trim().split(/[ ,]+/).map(Number);k=new n.Arrow({...v,points:e,pointerLength:8,pointerWidth:6,fill:g?u:void 0})}else k=new n.Path({...v,data:i});g&&(k.on("mouseenter",()=>{e.container().style.cursor="pointer",k.stroke("#00A1FF"),a.batchDraw()}),k.on("mouseleave",()=>{e.container().style.cursor="default",k.stroke(g?u:void 0),a.batchDraw()})),p.add(k),a.add(p)}),a.batchDraw()}(e,t),function(e,t){let a=e.findOne("#nodeLayer")||new n.Layer({id:"nodeLayer",name:"nodeLayer"});e.findOne("#nodeLayer")||e.add(a),t.querySelectorAll("g").forEach(e=>{const t=e.querySelectorAll(":scope > rect"),o=e.querySelectorAll(":scope > ellipse"),i=e.querySelectorAll(":scope > title"),r=t.length+o.length,s=1===i.length,l=!e.querySelector("path, text");if(1!==r||!s||!l)return;const{absX:d,absY:c,absRotation:f,absScaleX:h,absScaleY:p}=w(e),u=t.length>0?"breaker":"circleNode",g=new n.Group({x:d,y:c,rotation:f,scaleX:h,scaleY:p,name:"".concat(u,"Group"),id:"nodeGroup-".concat(u,"-").concat(e.id)});let m;if("breaker"===u){const e=t[0],a=y[e.getAttribute("class")]||{};m=new n.Rect({x:parseFloat(e.getAttribute("x"))||0,y:parseFloat(e.getAttribute("y"))||0,width:parseFloat(e.getAttribute("width"))||0,height:parseFloat(e.getAttribute("height"))||0,fill:a.fill||"#ffffff",stroke:a.stroke||"#ffffff",strokeWidth:parseFloat(a["stroke-width"])||1,name:"nodeBody"})}else{const e=o[0],t=y[e.getAttribute("class")]||{};m=new n.Ellipse({x:parseFloat(e.getAttribute("cx"))||0,y:parseFloat(e.getAttribute("cy"))||0,radiusX:parseFloat(e.getAttribute("rx"))||0,radiusY:parseFloat(e.getAttribute("ry"))||0,fill:t.fill||"#ffffff",stroke:t.stroke||"#ffffff",strokeWidth:parseFloat(t["stroke-width"])||1,name:"nodeBody"})}g.add(m),a.add(g)}),a.batchDraw()}(e,t),function(e,t){let a=e.findOne("#textLayer")||new n.Layer({id:"textLayer",name:"textLayer"});e.findOne("#textLayer")||e.add(a),t.querySelectorAll("text").forEach(e=>{const t=e.closest("g");if(!t)return;let o=0,i=0,r=0,s=e.parentElement;for(;s&&"svg"!==s.tagName;){const e=s.getAttribute("transform");if(e){const t=e.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);t&&(o+=parseFloat(t[1])||0,i+=parseFloat(t[2])||0);const n=e.match(/rotate\(([^)]+)\)/);n&&(r+=parseFloat(n[1])||0)}s=s.parentElement}const l=new n.Group({x:o,y:i,rotation:r,name:"textGroup",id:"textGroup-"+(t.id||Math.random().toString(36).substr(2,9))}),d=t.querySelector(":scope > rect");let c={x:0,y:0,w:0,h:0},f=!1;if(d){const e=d.getAttribute("class"),t=(void 0!==y?y[e]:{})||{},a=(t.fill||"").toLowerCase(),o=(t.stroke||"").toLowerCase(),i=!a||"none"===a||"#ffffff"===a||"white"===a,r=!o||"none"===o;if(f=!i||!r,c.x=parseFloat(d.getAttribute("x"))||0,c.y=parseFloat(d.getAttribute("y"))||0,c.w=parseFloat(d.getAttribute("width"))||0,c.h=parseFloat(d.getAttribute("height"))||0,f){const e=new n.Rect({x:c.x,y:c.y,width:c.w,height:c.h,fill:i?void 0:t.fill,fillEnabled:!i,stroke:r?void 0:t.stroke,strokeEnabled:!r,strokeWidth:parseFloat(t["stroke-width"])||.72,name:"textBackground",listening:!1});l.add(e)}}let h=[],p="";e.childNodes.forEach(e=>{3===e.nodeType?p+=e.textContent.trim():"newlineChar"===e.localName?(h.push(p),p=""):"tspan"===e.localName&&(e.getAttribute("dy")&&parseFloat(e.getAttribute("dy"))>.5?(p&&h.push(p),p=e.textContent.trim()):p+=e.textContent.trim())}),p&&h.push(p);const u=e.getAttribute("class"),g=(void 0!==y?y[u]:{})||{};let m=12;g["font-size"]&&(m=parseFloat(g["font-size"])*(g["font-size"].includes("em")?12:1));const b=f?c.x:parseFloat(e.getAttribute("x"))||0,x=f?c.w:void 0,w=f?"center":"left",v=new n.Text({x:b,y:parseFloat(e.getAttribute("y"))||0,width:x,align:w,offsetY:h.length>1?1*m:.85*m,text:h.join("\n"),fontSize:m,fontFamily:(g["font-family"]||"楷体").replace(/'/g,""),fill:g.fill||"black",fontStyle:"bold"===g["font-weight"]?"bold":"normal",lineHeight:1.2,name:"textBody"});l.add(v),a.add(l)}),a.batchDraw()}(e,t)}function E(e,t,a="KonvaPage"){!function(e){const t=()=>{const n=e.container().parentNode;if(!n)return console.error("Konva Stage 容器的父节点未找到。无法同步尺寸。"),void window.removeEventListener("resize",t);const a=n.offsetWidth,o=n.offsetHeight;e.width()===a&&e.height()===o||(e.width(a),e.height(o),e.batchDraw(),console.log("Stage 尺寸已更新: ".concat(a,"x").concat(o)))};t(),window.addEventListener("resize",t)}(e),function(e,t=!0){e.find("Group").forEach(e=>{e.draggable(t),e.listening(t)}),e.draggable(!0),e.batchDraw(),console.log("[交互控制] 所有 Group 拖拽状态已设为: ".concat(t))}(e),function(e){const t=e.getClientRect({skipTransform:!0,skipShadow:!0});if(!t||0===t.width||0===t.height)return e.position({x:0,y:0}),e.scale({x:1,y:1}),void e.batchDraw();const n=e.width(),a=e.height(),o=.9*n/t.width,i=.9*a/t.height,r=Math.min(o,i),s=n/2-(t.x+t.width/2)*r,l=.05*a-t.y*r;e.setAttrs({scaleX:r,scaleY:r,x:s,y:l}),e.batchDraw()}(e),function(e){const t=e.find("Text");let n=!1;t.forEach(e=>{e.fontSize()>70&&(e.fontSize(80),n=!0)}),n&&e.getLayers().forEach(e=>{e.batchDraw()}),e.on("wheel",t=>{t.evt.preventDefault();const n=e.scaleX(),a=e.getPointerPosition(),o=(a.x-e.x())/n,i=(a.y-e.y())/n,r=(t.evt.deltaY>0?-1:1)>0?1.1*n:n/1.1;e.scale({x:r,y:r});const s={x:a.x-o*r,y:a.y-i*r};e.position(s),e.batchDraw()})}(e),t&&(x(e),function(e,t){const a="konva-stencil-panel";if(!document.getElementById(a)){const e=document.createElement("div");e.id=a,e.style.cssText="\n      position: absolute; left: 10px; top: 10px; width: 110px; height: calc(100% - 20px);\n      background: #fff; padding: 20px 10px; display: flex; \n      flex-direction: column; gap: 12px; z-index: 9999;\n      box-shadow: 0 0 10px rgba(0,0,0,0.5);\n    ";const n=document.createElement("div");n.innerText="图元库",n.style.cssText="color: #888; font-size: 12px; text-align: center; margin-bottom: 10px;",e.appendChild(n),Object.keys(v).forEach(t=>{const n=document.createElement("div");n.innerText=v[t].label,n.draggable=!0,n.style.cssText="\n        padding: 10px 5px; background: #fff; color: #333; cursor: grab;\n        border: 1px solid #888; border-radius: 4px; text-align: center; \n        font-size: 11px; transition: all 0.2s;\n      ",n.onmouseenter=()=>n.style.borderColor="#007bff",n.onmouseleave=()=>n.style.borderColor="#444",n.ondragstart=e=>{e.dataTransfer.setData("konva-type",t)},e.appendChild(n)}),document.getElementById(t).appendChild(e)}const o=e.container();o.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),o.addEventListener("drop",t=>{t.preventDefault();const a=t.dataTransfer.getData("konva-type"),o=v[a];if(!o)return;e.setPointersPositions(t);const i=e.getPointerPosition(),r=e.getAbsoluteTransform().copy().invert().point(i),s=o.create(r);let l="textGroup"===s.name()?"textLayer":"nodeLayer",d=e.findOne("#"+l)||e.findOne("."+l);d||(d=new n.Layer({id:l,name:l}),e.add(d)),d.add(s),d.batchDraw(),"drag-text"===a&&x(e),console.log("Successfully created: ".concat(a," at"),r)})}(e,a),function(e){const t="selection-layer";let a=e.findOne("."+t);a||(a=new n.Layer({name:t,listening:!0}),e.add(a));const o=new n.Transformer({nodes:[],rotateEnabled:!0,keepRatio:!0,borderStroke:"#00A1FF",borderStrokeWidth:2,anchorSize:8,name:"globalTransformer",padding:2,boundBoxFunc:(e,t)=>Math.abs(t.width)<5||Math.abs(t.height)<5?e:t});a.add(o),e.on("click tap",t=>{var i;if(e.findOne("#helperLayer"))return;const r=t.target;if(r===e||r instanceof n.Layer||r.getParent()instanceof n.Transformer||(null==(i=r.name())?void 0:i.includes("Transformer")))return o.nodes([]),void a.batchDraw();let s=null,l=r;for(;l&&l!==e;){if(l instanceof n.Group&&(l.name()||"").toLowerCase().includes("group")){s=l;break}l=l.getParent()}s?(o.nodes().includes(s)||(o.nodes([s]),s.moveToTop(),a.moveToTop()),a.batchDraw(),t.cancelBubble=!0):(o.nodes([]),a.batchDraw())}),e.on("dragmove transform",e=>{o.nodes().includes(e.target)&&(o.update(),a.batchDraw())}),a.batchDraw()}(e),k(e))}let D;const A={id:"KonvaPage"};const S=a({props:{name:{type:Object},type:{type:String,default:""}},data:()=>({stage:null,row:{id:"",name:"",time:"",flag:"",svg:""},tableData:[]}),computed:{gridOptions(){return{height:"auto",border:!0,round:!0,headerAlign:"center",align:"center",loading:!1,rowConfig:{isCurrent:!0,isHover:!0},headerCellClassName:"row-class",data:this.tableData,columns:[{field:"time",title:"历史版本"}]}}},watch:{"row.time":{handler(){this.$refs.xTable.setCurrentRow(this.row),this.initKonvaEdit(this.row.svg)},immediate:!1}},mounted(){this.loadPage()},beforeUnmount(){},methods:{loadPage(){b.queryInitFstService({name:this.name}).then(e=>{this.tableData=e.data,this.row=e.data.filter(e=>1==e.flag)[0]})},initKonvaEdit(e){D=n.Node.create(e,"KonvaContainer"),this.stage=D,E(D,!0,"KonvaPage");let t=document.getElementById("konva-stencil-panel");t.style.height="calc(50% - 20px)",t.style.width="130px"},doImport(e){const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=e=>{const t=(new DOMParser).parseFromString(e.target.result,"image/svg+xml");D=new n.Stage({container:"KonvaContainer",draggable:!0}),C(D,t),E(D)},a.readAsText(t)},doUp(){this.$refs.uploadFile.click()},doJson(e){this.row.svg=D.toJSON(),console.log(e),console.log(this.row),e?b.saveDataService({data:[{name:this.name,svg:this.row.svg}]}).then(e=>{this.$message.success(e.data),this.$emit("refresh"),this.$emit("close")}):b.saveDataService({data:[this.row]}).then(e=>{this.$message.success(e.data),this.$emit("refresh"),this.$emit("close")})},setCurrent(){let e=JSON.parse(JSON.stringify(this.row));e.flag="1",b.setCurrentService({data:e}).then(e=>{this.$emit("refresh"),this.$emit("close")})},cellClick({row:e,column:t}){this.row=e}}},[["render",function(e,t,n,a,h,p){const u=o("el-button"),g=o("vxe-grid");return i(),r("div",A,[t[8]||(t[8]=s("div",{id:"KonvaContainer"},null,-1)),s("footer",null,[l(u,{type:"primary",plain:"",size:"small",onClick:p.doUp},{default:d(()=>[s("input",{accept:".svg",type:"file",style:{display:"none"},onChange:t[0]||(t[0]=e=>p.doImport(e)),ref:"uploadFile"},null,544),t[4]||(t[4]=s("div",{class:"icon-text"},"导入svg",-1))]),_:1},8,["onClick"]),l(u,{type:"primary",plain:"",size:"small",onClick:t[1]||(t[1]=e=>p.doJson(!1))},{default:d(()=>[...t[5]||(t[5]=[c(" 修改版本 ",-1)])]),_:1}),l(u,{type:"primary",plain:"",size:"small",onClick:t[2]||(t[2]=e=>p.doJson(!0))},{default:d(()=>[...t[6]||(t[6]=[c(" 新增版本 ",-1)])]),_:1}),l(u,{type:"primary",plain:"",size:"small",onClick:t[3]||(t[3]=e=>p.setCurrent())},{default:d(()=>[...t[7]||(t[7]=[c(" 设为版本 ",-1)])]),_:1})]),s("aside",null,[l(g,f(p.gridOptions,{ref:"xTable",onCellClick:p.cellClick}),null,16,["onCellClick"])])])}],["__scopeId","data-v-5f473dad"]]);let L;const F={class:"page_content"},T={class:"header-item"},N={class:"right"},O={class:"childTables"};const M=a({name:"pzgl",data:()=>({name:"",picOptions:[],row:{id:"",name:"",time:"",flag:"",svg:""},dragState:{isDragging:!1,ghostNode:null,draggedItemType:null,nodeSize:0},tableData:[],seatchParams:{date:g().format("YYYY-MM-DD HH:mm")}}),watch:{name:{handler(e){e?(this.row=this.picOptions.filter(t=>t.name===e)[0],this.getTable()):this.row={id:"",name:"",time:"",flag:"",svg:""}},immediate:!1},"row.svg":{handler(e){e?this.initKonvaEdit(e):L&&L.destroy()},immediate:!1}},beforeUnmount(){},created(){this.loadPage()},methods:{getTable(){b.seletNormalDiagramList({substationName:this.name,date:g(this.seatchParams.date).format("YYYY-MM-DD"),time:g(this.seatchParams.date).format("HH")+":00",equipmentName:"",belongSubstationName:""}).then(e=>{this.tableData=e.data,function(e,t,n=60){if(!e||!Array.isArray(t))return;const a=new Set,o="#0000ff",i=e.find("Rect").filter(e=>"textBackground"!==e.name());i.forEach(e=>{e.isCached()&&e.clearCache(),e.setAttrs({fill:o,opacity:1,visible:!0,fillEnabled:!0});const t=e.getLayer();t&&a.add(t)});const r=e.find("Group, Line, Rect, Ellipse, Path, Text");t.forEach(e=>{const{jsonId:t,statusDesc:s}=e;if(!t)return;const l=r.find(e=>{const n=e.id();return n&&String(n)===String(t).trim()});if(!l)return;const d=l.getClientRect(),c=d.x+d.width/2,f=d.y+d.height/2;let h=1/0,p=null;if(i.forEach(e=>{if(e===l)return;const t=e.getClientRect(),a=t.x+t.width/2,o=t.y+t.height/2,i=Math.sqrt(Math.pow(c-a,2)+Math.pow(f-o,2));i<h&&i<=n&&(h=i,p=e)}),p){const e="合"===s?"#ffffff":o;p.setAttrs({fill:e,fillEnabled:!0});const t="konvaFlashAnimation",n=p.getAttr(t);n&&n.isRunning()&&p.opacity(1);const i=p.getLayer();i&&a.add(i)}}),a.forEach(e=>{e.batchDraw()})}(L,e.data.filter(e=>"开关"===e.equipmentType))})},loadPage(){b.loadDataService({}).then(e=>{this.picOptions=e.data,this.picOptions.length>0&&(this.name?this.row=this.picOptions.filter(e=>e.name===this.name)[0]:this.name=this.picOptions[0].name)})},initKonvaEdit(e){L=n.Node.create(e,"KonvaContainer0"),this.stage=L,E(L)},openDetail(){this.$vxeModal.show(S,{name:this.name},{width:window.innerWidth-100,title:"".concat(this.name,"详情"),height:window.innerHeight-100},{refresh:()=>{this.loadPage()}})},cellClickEvent({row:e}){console.log(e),"开关"===e.equipmentType&&function(e,t,a=1.2,o=500,i=1.01,r=!0,s=60){if(!e||"Stage"!==e.getClassName()||!t)return console.error("未提供有效的 Konva Stage 实例或 targetId。"),[];const l="konvaFlashAnimation";e.find("Group, Line, Rect, Ellipse, Path, Text").forEach(e=>{const t=e.getAttr(l);t&&(t.isRunning()&&t.stop(),e.setAttr(l,null)),e.opacity(1)});const d=(Array.isArray(t)?t.map(e=>String(e).trim()):String(t).split(",").map(e=>String(e).trim())).filter(Boolean);if(0===d.length)return[];let c=e.find("Group, Line, Rect, Ellipse, Path, Text").filter(e=>{const t=e.id();return!!t&&d.includes(String(t))});if(0===c.length)return console.warn("未找到与 id: ".concat(d.join(", ")," 关联的节点/线路。")),[];if(r){const t=[],n=e.find("Rect").filter(e=>"textBackground"!==e.name());c.forEach(e=>{const a=e.getClientRect(),o=a.x+a.width/2,i=a.y+a.height/2;let r=1/0,l=null;n.forEach(t=>{if(t===e)return;const n=t.getClientRect(),a=n.x+n.width/2,d=n.y+n.height/2,c=Math.sqrt(Math.pow(o-a,2)+Math.pow(i-d,2));c<r&&c<=s&&(r=c,l=t)}),l&&!c.includes(l)&&t.push(l)}),c=[...c,...t]}let f=1/0,h=1/0,p=-1/0,u=-1/0;c.forEach(t=>{const n=t.getClientRect({relativeTo:e});f=Math.min(f,n.x),h=Math.min(h,n.y),p=Math.max(p,n.x+n.width),u=Math.max(u,n.y+n.height)});const g=Math.max(1,p-f),m=Math.max(1,u-h),b=f+g/2,x=h+m/2,y=e.width(),w=e.height(),v=y/(g*a),k=w/(m*a);let C=Math.min(v,k);C=Math.min(Math.max(C,.1),i);const E=y/2-b*C,D=w/2-x*C;function A(e){const t=e.getAttr(l);t&&t.isRunning()&&t.stop();let a=0,i=!0;const r=new n.Animation(t=>{t&&t.time-a>o&&(i=!i,e.opacity(i?1:0),a=t.time)},e.getLayer());e.setAttr(l,r),r.start()}new n.Tween({node:e,duration:.8,x:E,y:D,scaleX:C,scaleY:C,easing:n.Easings.EaseInOut,onFinish:()=>{c.forEach(A),e.batchDraw()}}).play()}(L,e.jsonId)}}},[["render",function(e,t,n,a,f,g){const m=o("el-option"),b=o("el-select"),x=o("el-button"),y=o("el-date-picker"),w=o("vxe-column"),v=o("vxe-table");return i(),r("div",F,[s("header",null,[s("section",null,[s("div",T,[t[2]||(t[2]=c(" 图： ",-1)),l(b,{modelValue:f.name,"onUpdate:modelValue":t[0]||(t[0]=e=>f.name=e),placeholder:"请选择",clearable:"",style:{width:"300px"}},{default:d(()=>[(i(!0),r(h,null,p(f.picOptions,e=>(i(),u(m,{label:e.name,value:e.name},null,8,["label","value"]))),256))]),_:1},8,["modelValue"])])]),s("section",null,[l(x,{type:"gradientGreen",onClick:g.openDetail},{default:d(()=>[...t[3]||(t[3]=[c("查看详情",-1)])]),_:1},8,["onClick"])])]),t[5]||(t[5]=s("div",{class:"left"},[s("div",{id:"KonvaContainer0"})],-1)),s("div",N,[l(y,{modelValue:f.seatchParams.date,"onUpdate:modelValue":t[1]||(t[1]=e=>f.seatchParams.date=e),type:"datetime",placeholder:"选择日期时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm"},null,8,["modelValue"]),l(x,{onClick:g.getTable},{default:d(()=>[...t[4]||(t[4]=[c("查询",-1)])]),_:1},8,["onClick"]),l(v,{ref:"tableRef",data:f.tableData,stripe:"","keep-source":"",border:"",height:"100%",round:!0,resizable:"","row-config":{isHover:!0},align:"center",onCellClick:g.cellClickEvent},{default:d(()=>[l(w,{type:"expand",fixed:"left",width:"50"},{content:d(({row:e})=>[s("div",O,[l(v,{border:"",data:e.transformerPhaseDataList,"auto-resize":"",stripe:"","row-id":"id","row-config":{isHover:!0},round:!0,"keep-source":"",resizable:"",align:"center"},{default:d(()=>[l(w,{type:"seq",title:"序号",width:"60"}),l(w,{field:"equipmentName",title:"设备名称","min-width":"120"}),l(w,{field:"yg",title:"有功值",width:"120",sortable:""}),l(w,{field:"wg",title:"无功值",width:"120",sortable:""}),l(w,{field:"dl",title:"电流值",width:"120",sortable:""})]),_:1},8,["data"])])]),_:1}),l(w,{type:"seq",title:"序号",width:"60"}),l(w,{field:"substationName",title:"变电站名称","min-width":"120"}),l(w,{field:"equipmentName",title:"设备名称","min-width":"120"}),l(w,{field:"equipmentType",title:"设备类型",width:"120"}),l(w,{field:"belongSubstationName",title:"所属变电站","min-width":"120"}),l(w,{field:"statusDesc",title:"开关状态",width:"120"}),l(w,{field:"yg",title:"有功值",width:"110",sortable:"","header-align":"center",align:"right"}),l(w,{field:"wg",title:"无功值",width:"110",sortable:"","header-align":"center",align:"right"}),l(w,{field:"dl",title:"电流值",width:"110",sortable:"","header-align":"center",align:"right"})]),_:1},8,["data","onCellClick"])])])}],["__scopeId","data-v-e0e81125"]]);export{M as default};
