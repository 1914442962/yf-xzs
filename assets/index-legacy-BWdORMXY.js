!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,a)}return n}function t(t){for(var a=1;a<arguments.length;a++){var i=null!=arguments[a]?arguments[a]:{};a%2?e(Object(i),!0).forEach(function(e){n(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./index-legacy-BhBZRkTD.js","./polyfill-legacy-aWkUxw0k.js"],function(e,n){"use strict";var a,i,o,r,l,s,d,c,f,h,p,u,g,m,b,y;return{setters:[e=>{a=e.A,i=e.B,o=e.cE,r=e.b,l=e.r,s=e.o,d=e.c,c=e.d,f=e.e,h=e.w,p=e.i,u=e.x,g=e.F,m=e.v,b=e.f,y=e.z},null],execute:function(){let n=i.base;const x={loadDataService:e=>a({url:`${n}/first/queryAllFst`,method:"post",data:e,showLoading:!0}),seletNormalDiagramList:e=>a({url:`${n}/NormalDiagramController/seletNormalDiagramList`,method:"post",data:e,showLoading:!0}),queryInitFstService:e=>a({url:`${n}/first/queryInitFst`,method:"post",data:e,showLoading:!0}),saveDataService:e=>a({url:`${n}/first/saveFst`,method:"post",data:e,showLoading:!0}),setCurrentService:e=>a({url:`${n}/first/changeFst`,method:"post",data:e,showLoading:!0})};function w(e){e.find(".textGroup").forEach(t=>{t.off("dblclick dbltap"),t.on("dblclick dbltap",n=>{const a=t.findOne(".textBody");if(!a)return;const i=document.getElementById("text-editor-save-btn");i&&i.click(),function(t){const n=t.getParent(),a=n?n.findOne(".textBackground"):null,i=t.text(),o=a?a.height():0,r=t.height(),l=o-r,s=l>0?l:4;if(document.getElementById("text-edit-modal-dynamic"))return;const d=document.createElement("div");d.id="text-edit-modal-dynamic",d.style.cssText="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); border: 1px solid #ddd; z-index: 10000;";const c=document.createElement("textarea");c.value=i,c.style.cssText="width: 320px; height: 140px; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; line-height: 1.2; display: block; outline: none;";const f=document.createElement("button");f.innerText="完成",f.id="text-editor-save-btn",f.style.cssText="padding: 8px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; float: right;";const h=document.createElement("button");h.innerText="取消",h.style.cssText="padding: 8px 15px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; float: right; margin-right: 10px;",d.appendChild(c),d.appendChild(f),d.appendChild(h),document.body.appendChild(d),c.addEventListener("input",()=>{const n=c.value;if(t.text(n),a){const e=a.width();t.setAttrs({width:e,wrap:"word"}),t.getSelfRect();const n=t.height()+s;a.height(Math.max(n,o))}e.batchDraw()}),f.onclick=()=>{d.parentNode&&d.parentNode.removeChild(d),t.listening(!0),n&&n.listening(!0)},h.onclick=()=>{t.text(i),a&&a.height(o),e.batchDraw(),d.parentNode&&d.parentNode.removeChild(d),t.listening(!0),n&&n.listening(!0)},c.addEventListener("keydown",e=>{"Enter"===e.key&&e.ctrlKey?(e.preventDefault(),f.click()):"Escape"===e.key&&h.click()}),t.listening(!1),n&&n.listening(!1),c.focus(),c.select()}(a),n.cancelBubble=!0})})}const v={};function k(e){let t=0,n=0,a=0,i=1,o=1,r=e;for(;r&&"BODY"!==r.tagName;){var l;const e=r.getAttribute("transform");if(e){const r=e.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);r&&(t+=parseFloat(r[1])*i,n+=parseFloat(r[2])*o);const l=e.match(/matrix\(([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)[, ]+([^, ]+)\)/);if(l){const e=parseFloat(l[1]),a=parseFloat(l[4]);t+=parseFloat(l[5])*i,n+=parseFloat(l[6])*o,i*=e,o*=a}const s=e.match(/rotate\(([^)]+)\)/);s&&(a+=parseFloat(s[1]))}if("svg"===r.tagName&&(t+=parseFloat(r.getAttribute("x")||0)*i,n+=parseFloat(r.getAttribute("y")||0)*o),r=r.parentElement,!r||"svg"===r.tagName&&"g"!==(null===(l=r.parentElement)||void 0===l?void 0:l.tagName))break}return"text"===e.tagName&&(t+=parseFloat(e.getAttribute("x")||0)*i,n+=parseFloat(e.getAttribute("y")||0)*o),{absX:t,absY:n,absRotation:a,absScaleX:i,absScaleY:o}}const C={"drag-text":{label:"拖拽文本",create:e=>{const t=new o.Group({x:e.x,y:e.y,draggable:!0,name:"textGroup"}),n=new o.Rect({width:80,height:25,fill:"#ffffff",stroke:"#000000",strokeWidth:1,name:"textBackground"}),a=new o.Text({x:0,y:6,width:80,text:"新节点",fontSize:12,fontFamily:"黑体",align:"center",fontWeight:"bold",fill:"#000000",name:"textBody"});return t.add(n,a),t}},"breaker-node":{label:"开关节点",create:e=>{const t=new o.Group({x:e.x,y:e.y,draggable:!0,name:"breakerGroup"}),n=new o.Rect({width:40,height:20,fill:"#ffffff",stroke:"#ff0000",strokeWidth:2,name:"nodeBody"});return t.add(n),t}}};function E(e){const t="konva-dynamic-context-menu",n=".globalTransformer";let a=document.getElementById(t);a||(a=document.createElement("div"),a.id=t,a.style.cssText="\n      position: fixed; display: none; width: 150px; background: #2b2b2b;\n      border: 1px solid #444; border-radius: 4px; flex-direction: column;\n      padding: 5px 0; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n      font-family: Arial, sans-serif; color: #eee; font-size: 13px; cursor: default;\n    ",document.body.appendChild(a));let i=[];e.on("contextmenu",t=>{t.evt.preventDefault();const r=e.findOne(n),l=r?r.nodes():[];let s=null,d=t.target;for(;d&&d!==e;){var c;if(d instanceof o.Group&&null!==(c=d.name())&&void 0!==c&&c.toLowerCase().includes("group")){s=d;break}d=d.getParent()}const f=t.target.getParent()instanceof o.Transformer;s||f?(i=l.includes(s)?l:s?[s]:[],(()=>{a.innerHTML="";const t=document.createElement("div");if(t.style.cssText="display:flex; align-items:center; padding: 8px 12px; border-bottom: 1px solid #333; cursor: pointer;",t.innerHTML='<span style="flex:1">修改颜色</span><input type="color" id="picker-inner" style="width:24px; height:24px; border:none; background:none; cursor:pointer;">',t.querySelector("input").oninput=t=>{const n=t.target.value;i.forEach(e=>{e.find("Text, Line, Rect, Circle, Path").forEach(e=>{"Text"===e.getClassName()||e.hasFill()&&!["transparent","white","#ffffff"].includes(e.fill())?e.fill(n):e.stroke(n)})}),e.batchDraw()},a.appendChild(t),i.some(e=>e.findOne(".wireBody")||e.findOne("Line"))){const t=document.createElement("div");t.innerText="切换虚线",t.style.cssText="padding: 8px 12px; cursor: pointer;",t.onclick=t=>{t.stopPropagation(),i.forEach(e=>{const t=e.findOne(".wireBody")||e.findOne("Line");if(t){const e=t.dash()&&t.dash().length>0;t.dash(e?[]:[10,5])}}),e.batchDraw(),a.style.display="none"},t.onmouseenter=()=>t.style.background="#3e95ff",t.onmouseleave=()=>t.style.background="transparent",a.appendChild(t)}const o=document.createElement("div");o.innerText="删除选中",o.style.cssText="padding: 8px 12px; cursor: pointer; color: #ff5555;",o.onclick=t=>{t.stopPropagation(),i.forEach(e=>e.destroy());const o=e.findOne(n);o&&o.nodes([]),e.batchDraw(),a.style.display="none"},o.onmouseenter=()=>o.style.background="#3e95ff",o.onmouseleave=()=>o.style.background="transparent",a.appendChild(o)})(),a.style.display="flex",a.style.left=t.evt.clientX+"px",a.style.top=t.evt.clientY+"px"):a.style.display="none"}),window.addEventListener("click",()=>{a.style.display="none"})}function D(e,n){!function(e){const t=e.querySelector("style");if(t){const e=t.textContent,n=/\.([a-zA-Z0-9_-]+)\s*\{([^}]+)\}/g;let a;for(;null!==(a=n.exec(e));){const e=a[1],t=a[2].split(";").reduce((e,t)=>{const[n,a]=t.split(":");return n&&a&&(e[n.trim()]=a.trim()),e},{});v[e]=t}}}(n),function(e,n){let a=e.findOne("#lineLayer")||new o.Layer({id:"lineLayer",name:"lineLayer"});e.findOne("#lineLayer")||e.add(a),n.querySelectorAll("path").forEach(n=>{if(n.closest("switch")||n.closest("foreignObject"))return;const i=n.closest("g");if(i&&i.querySelector("text"))return;const r=n.getAttribute("d");if(!r)return;const{absX:l,absY:s,absRotation:d,absScaleX:c,absScaleY:f}=k(n),h=n.getAttribute("class"),p=v[h]||{},u=new o.Group({x:l,y:s,rotation:d,scaleX:c,scaleY:f,name:"lineGroup",id:`lineGroup-${i?i.id:Math.random().toString(36).substr(2,9)}`}),g=(p.stroke||"").toLowerCase(),m=g&&"none"!==g,b=(p.fill||"").toLowerCase(),y=b&&"none"!==b,x=r.trim().toLowerCase().endsWith("z"),w={x:0,y:0,stroke:m?g:void 0,strokeEnabled:m,strokeWidth:m?parseFloat(p["stroke-width"])||1:0,fill:y?b:x?"white":void 0,fillEnabled:y||x,lineCap:"round",lineJoin:"round",dash:p["stroke-dasharray"]?p["stroke-dasharray"].split(/[, ]+/).map(Number):null,name:"wireBody"};let C;if(p["marker-end"]||n.getAttribute("marker-end")){const e=r.replace(/[MLZz]/g," ").trim().split(/[ ,]+/).map(Number);C=new o.Arrow(t(t({},w),{},{points:e,pointerLength:8,pointerWidth:6,fill:m?g:void 0}))}else C=new o.Path(t(t({},w),{},{data:r}));m&&(C.on("mouseenter",()=>{e.container().style.cursor="pointer",C.stroke("#00A1FF"),a.batchDraw()}),C.on("mouseleave",()=>{e.container().style.cursor="default",C.stroke(m?g:void 0),a.batchDraw()})),u.add(C),a.add(u)}),a.batchDraw()}(e,n),function(e,t){let n=e.findOne("#nodeLayer")||new o.Layer({id:"nodeLayer",name:"nodeLayer"});e.findOne("#nodeLayer")||e.add(n),t.querySelectorAll("g").forEach(e=>{const t=e.querySelectorAll(":scope > rect"),a=e.querySelectorAll(":scope > ellipse"),i=e.querySelectorAll(":scope > title"),r=t.length+a.length,l=1===i.length,s=!e.querySelector("path, text");if(1!==r||!l||!s)return;const{absX:d,absY:c,absRotation:f,absScaleX:h,absScaleY:p}=k(e),u=t.length>0?"breaker":"circleNode",g=new o.Group({x:d,y:c,rotation:f,scaleX:h,scaleY:p,name:`${u}Group`,id:`nodeGroup-${u}-${e.id}`});let m;if("breaker"===u){const e=t[0],n=v[e.getAttribute("class")]||{};m=new o.Rect({x:parseFloat(e.getAttribute("x"))||0,y:parseFloat(e.getAttribute("y"))||0,width:parseFloat(e.getAttribute("width"))||0,height:parseFloat(e.getAttribute("height"))||0,fill:n.fill||"#ffffff",stroke:n.stroke||"#ffffff",strokeWidth:parseFloat(n["stroke-width"])||1,name:"nodeBody"})}else{const e=a[0],t=v[e.getAttribute("class")]||{};m=new o.Ellipse({x:parseFloat(e.getAttribute("cx"))||0,y:parseFloat(e.getAttribute("cy"))||0,radiusX:parseFloat(e.getAttribute("rx"))||0,radiusY:parseFloat(e.getAttribute("ry"))||0,fill:t.fill||"#ffffff",stroke:t.stroke||"#ffffff",strokeWidth:parseFloat(t["stroke-width"])||1,name:"nodeBody"})}g.add(m),n.add(g)}),n.batchDraw()}(e,n),function(e,t){let n=e.findOne("#textLayer")||new o.Layer({id:"textLayer",name:"textLayer"});e.findOne("#textLayer")||e.add(n),t.querySelectorAll("text").forEach(e=>{const t=e.closest("g");if(!t)return;let a=0,i=0,r=0,l=e.parentElement;for(;l&&"svg"!==l.tagName;){const e=l.getAttribute("transform");if(e){const t=e.match(/translate\(([^, ]+)[, ]+([^)]+)\)/);t&&(a+=parseFloat(t[1])||0,i+=parseFloat(t[2])||0);const n=e.match(/rotate\(([^)]+)\)/);n&&(r+=parseFloat(n[1])||0)}l=l.parentElement}const s=new o.Group({x:a,y:i,rotation:r,name:"textGroup",id:"textGroup-"+(t.id||Math.random().toString(36).substr(2,9))}),d=t.querySelector(":scope > rect");let c={x:0,y:0,w:0,h:0},f=!1;if(d){const e=d.getAttribute("class"),t=(void 0!==v?v[e]:{})||{},n=(t.fill||"").toLowerCase(),a=(t.stroke||"").toLowerCase(),i=!n||"none"===n||"#ffffff"===n||"white"===n,r=!a||"none"===a;if(f=!i||!r,c.x=parseFloat(d.getAttribute("x"))||0,c.y=parseFloat(d.getAttribute("y"))||0,c.w=parseFloat(d.getAttribute("width"))||0,c.h=parseFloat(d.getAttribute("height"))||0,f){const e=new o.Rect({x:c.x,y:c.y,width:c.w,height:c.h,fill:i?void 0:t.fill,fillEnabled:!i,stroke:r?void 0:t.stroke,strokeEnabled:!r,strokeWidth:parseFloat(t["stroke-width"])||.72,name:"textBackground",listening:!1});s.add(e)}}let h=[],p="";e.childNodes.forEach(e=>{3===e.nodeType?p+=e.textContent.trim():"newlineChar"===e.localName?(h.push(p),p=""):"tspan"===e.localName&&(e.getAttribute("dy")&&parseFloat(e.getAttribute("dy"))>.5?(p&&h.push(p),p=e.textContent.trim()):p+=e.textContent.trim())}),p&&h.push(p);const u=e.getAttribute("class"),g=(void 0!==v?v[u]:{})||{};let m=12;g["font-size"]&&(m=parseFloat(g["font-size"])*(g["font-size"].includes("em")?12:1));const b=f?c.x:parseFloat(e.getAttribute("x"))||0,y=f?c.w:void 0,x=f?"center":"left",w=new o.Text({x:b,y:parseFloat(e.getAttribute("y"))||0,width:y,align:x,offsetY:h.length>1?1*m:.85*m,text:h.join("\n"),fontSize:m,fontFamily:(g["font-family"]||"楷体").replace(/'/g,""),fill:g.fill||"black",fontStyle:"bold"===g["font-weight"]?"bold":"normal",lineHeight:1.2,name:"textBody"});s.add(w),n.add(s)}),n.batchDraw()}(e,n)}function S(e,t,n="KonvaPage"){!function(e){const t=()=>{const n=e.container().parentNode;if(!n)return console.error("Konva Stage 容器的父节点未找到。无法同步尺寸。"),void window.removeEventListener("resize",t);const a=n.offsetWidth,i=n.offsetHeight;e.width()===a&&e.height()===i||(e.width(a),e.height(i),e.batchDraw(),console.log(`Stage 尺寸已更新: ${a}x${i}`))};t(),window.addEventListener("resize",t)}(e),function(e,t=!0){e.find("Group").forEach(e=>{e.draggable(t),e.listening(t)}),e.draggable(!0),e.batchDraw(),console.log(`[交互控制] 所有 Group 拖拽状态已设为: ${t}`)}(e),function(e){const t=e.getClientRect({skipTransform:!0,skipShadow:!0});if(!t||0===t.width||0===t.height)return e.position({x:0,y:0}),e.scale({x:1,y:1}),void e.batchDraw();const n=e.width(),a=e.height(),i=.9*n/t.width,o=.9*a/t.height,r=Math.min(i,o),l=n/2-(t.x+t.width/2)*r,s=.05*a-t.y*r;e.setAttrs({scaleX:r,scaleY:r,x:l,y:s}),e.batchDraw()}(e),function(e){const t=e.find("Text");let n=!1;t.forEach(e=>{e.fontSize()>70&&(e.fontSize(80),n=!0)}),n&&e.getLayers().forEach(e=>{e.batchDraw()}),e.on("wheel",t=>{t.evt.preventDefault();const n=e.scaleX(),a=e.getPointerPosition(),i=(a.x-e.x())/n,o=(a.y-e.y())/n,r=(t.evt.deltaY>0?-1:1)>0?1.1*n:n/1.1;e.scale({x:r,y:r});const l={x:a.x-i*r,y:a.y-o*r};e.position(l),e.batchDraw()})}(e),t&&(w(e),function(e,t){const n="konva-stencil-panel";if(!document.getElementById(n)){const e=document.createElement("div");e.id=n,e.style.cssText="\n      position: absolute; left: 10px; top: 10px; width: 110px; height: calc(100% - 20px);\n      background: #fff; padding: 20px 10px; display: flex; \n      flex-direction: column; gap: 12px; z-index: 9999;\n      box-shadow: 0 0 10px rgba(0,0,0,0.5);\n    ";const a=document.createElement("div");a.innerText="图元库",a.style.cssText="color: #888; font-size: 12px; text-align: center; margin-bottom: 10px;",e.appendChild(a),Object.keys(C).forEach(t=>{const n=document.createElement("div");n.innerText=C[t].label,n.draggable=!0,n.style.cssText="\n        padding: 10px 5px; background: #fff; color: #333; cursor: grab;\n        border: 1px solid #888; border-radius: 4px; text-align: center; \n        font-size: 11px; transition: all 0.2s;\n      ",n.onmouseenter=()=>n.style.borderColor="#007bff",n.onmouseleave=()=>n.style.borderColor="#444",n.ondragstart=e=>{e.dataTransfer.setData("konva-type",t)},e.appendChild(n)}),document.getElementById(t).appendChild(e)}const a=e.container();a.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"}),a.addEventListener("drop",t=>{t.preventDefault();const n=t.dataTransfer.getData("konva-type"),a=C[n];if(!a)return;e.setPointersPositions(t);const i=e.getPointerPosition(),r=e.getAbsoluteTransform().copy().invert().point(i),l=a.create(r);let s="textGroup"===l.name()?"textLayer":"nodeLayer",d=e.findOne("#"+s)||e.findOne("."+s);d||(d=new o.Layer({id:s,name:s}),e.add(d)),d.add(l),d.batchDraw(),"drag-text"===n&&w(e),console.log(`Successfully created: ${n} at`,r)})}(e,n),function(e){const t="selection-layer";let n=e.findOne("."+t);n||(n=new o.Layer({name:t,listening:!0}),e.add(n));const a=new o.Transformer({nodes:[],rotateEnabled:!0,keepRatio:!0,borderStroke:"#00A1FF",borderStrokeWidth:2,anchorSize:8,name:"globalTransformer",padding:2,boundBoxFunc:(e,t)=>Math.abs(t.width)<5||Math.abs(t.height)<5?e:t});n.add(a),e.on("click tap",t=>{var i;if(e.findOne("#helperLayer"))return;const r=t.target;if(r===e||r instanceof o.Layer||r.getParent()instanceof o.Transformer||null!==(i=r.name())&&void 0!==i&&i.includes("Transformer"))return a.nodes([]),void n.batchDraw();let l=null,s=r;for(;s&&s!==e;){if(s instanceof o.Group&&(s.name()||"").toLowerCase().includes("group")){l=s;break}s=s.getParent()}l?(a.nodes().includes(l)||(a.nodes([l]),l.moveToTop(),n.moveToTop()),n.batchDraw(),t.cancelBubble=!0):(a.nodes([]),n.batchDraw())}),e.on("dragmove transform",e=>{a.nodes().includes(e.target)&&(a.update(),n.batchDraw())}),n.batchDraw()}(e),E(e))}let A;const L={id:"KonvaPage"};const T=r({props:{name:{type:Object},type:{type:String,default:""}},data:()=>({stage:null,row:{id:"",name:"",time:"",flag:"",svg:""},tableData:[]}),computed:{gridOptions(){return{height:"auto",border:!0,round:!0,headerAlign:"center",align:"center",loading:!1,rowConfig:{isCurrent:!0,isHover:!0},headerCellClassName:"row-class",data:this.tableData,columns:[{field:"time",title:"历史版本"}]}}},watch:{"row.time":{handler(){this.$refs.xTable.setCurrentRow(this.row),this.initKonvaEdit(this.row.svg)},immediate:!1}},mounted(){this.loadPage()},beforeUnmount(){},methods:{loadPage(){x.queryInitFstService({name:this.name}).then(e=>{this.tableData=e.data,this.row=e.data.filter(e=>1==e.flag)[0]})},initKonvaEdit(e){A=o.Node.create(e,"KonvaContainer"),this.stage=A,S(A,!0,"KonvaPage");let t=document.getElementById("konva-stencil-panel");t.style.height="calc(50% - 20px)",t.style.width="130px"},doImport(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{const t=(new DOMParser).parseFromString(e.target.result,"image/svg+xml");A=new o.Stage({container:"KonvaContainer",draggable:!0}),D(A,t),S(A)},n.readAsText(t)},doUp(){this.$refs.uploadFile.click()},doJson(e){this.row.svg=A.toJSON(),console.log(e),console.log(this.row),e?x.saveDataService({data:[{name:this.name,svg:this.row.svg}]}).then(e=>{this.$message.success(e.data),this.$emit("refresh"),this.$emit("close")}):x.saveDataService({data:[this.row]}).then(e=>{this.$message.success(e.data),this.$emit("refresh"),this.$emit("close")})},setCurrent(){let e=JSON.parse(JSON.stringify(this.row));e.flag="1",x.setCurrentService({data:e}).then(e=>{this.$emit("refresh"),this.$emit("close")})},cellClick({row:e,column:t}){this.row=e}}},[["render",function(e,t,n,a,i,o){const r=l("el-button"),g=l("vxe-grid");return s(),d("div",L,[t[8]||(t[8]=c("div",{id:"KonvaContainer"},null,-1)),c("footer",null,[f(r,{type:"primary",plain:"",size:"small",onClick:o.doUp},{default:h(()=>[c("input",{accept:".svg",type:"file",style:{display:"none"},onChange:t[0]||(t[0]=e=>o.doImport(e)),ref:"uploadFile"},null,544),t[4]||(t[4]=c("div",{class:"icon-text"},"导入svg",-1))]),_:1},8,["onClick"]),f(r,{type:"primary",plain:"",size:"small",onClick:t[1]||(t[1]=e=>o.doJson(!1))},{default:h(()=>[...t[5]||(t[5]=[p(" 修改版本 ",-1)])]),_:1}),f(r,{type:"primary",plain:"",size:"small",onClick:t[2]||(t[2]=e=>o.doJson(!0))},{default:h(()=>[...t[6]||(t[6]=[p(" 新增版本 ",-1)])]),_:1}),f(r,{type:"primary",plain:"",size:"small",onClick:t[3]||(t[3]=e=>o.setCurrent())},{default:h(()=>[...t[7]||(t[7]=[p(" 设为版本 ",-1)])]),_:1})]),c("aside",null,[f(g,u(o.gridOptions,{ref:"xTable",onCellClick:o.cellClick}),null,16,["onCellClick"])])])}],["__scopeId","data-v-5f473dad"]]);let F;const O={class:"page_content"},P={class:"header-item"},N={class:"right"},M={class:"childTables"};e("default",r({name:"pzgl",data:()=>({name:"",picOptions:[],row:{id:"",name:"",time:"",flag:"",svg:""},dragState:{isDragging:!1,ghostNode:null,draggedItemType:null,nodeSize:0},tableData:[],seatchParams:{date:y().format("YYYY-MM-DD HH:mm")}}),watch:{name:{handler(e){e?(this.row=this.picOptions.filter(t=>t.name===e)[0],this.getTable()):this.row={id:"",name:"",time:"",flag:"",svg:""}},immediate:!1},"row.svg":{handler(e){e?this.initKonvaEdit(e):F&&F.destroy()},immediate:!1}},beforeUnmount(){},created(){this.loadPage()},methods:{getTable(){x.seletNormalDiagramList({substationName:this.name,date:y(this.seatchParams.date).format("YYYY-MM-DD"),time:y(this.seatchParams.date).format("HH")+":00",equipmentName:"",belongSubstationName:""}).then(e=>{this.tableData=e.data,function(e,t,n=60){if(!e||!Array.isArray(t))return;const a=new Set,i="#0000ff",o=e.find("Rect").filter(e=>"textBackground"!==e.name());o.forEach(e=>{e.isCached()&&e.clearCache(),e.setAttrs({fill:i,opacity:1,visible:!0,fillEnabled:!0});const t=e.getLayer();t&&a.add(t)});const r=e.find("Group, Line, Rect, Ellipse, Path, Text");t.forEach(e=>{const{jsonId:t,statusDesc:l}=e;if(!t)return;const s=r.find(e=>{const n=e.id();return n&&String(n)===String(t).trim()});if(!s)return;const d=s.getClientRect(),c=d.x+d.width/2,f=d.y+d.height/2;let h=1/0,p=null;if(o.forEach(e=>{if(e===s)return;const t=e.getClientRect(),a=t.x+t.width/2,i=t.y+t.height/2,o=Math.sqrt(Math.pow(c-a,2)+Math.pow(f-i,2));o<h&&o<=n&&(h=o,p=e)}),p){const e="合"===l?"#ffffff":i;p.setAttrs({fill:e,fillEnabled:!0});const t="konvaFlashAnimation",n=p.getAttr(t);n&&n.isRunning()&&p.opacity(1);const o=p.getLayer();o&&a.add(o)}}),a.forEach(e=>{e.batchDraw()})}(F,e.data.filter(e=>"开关"===e.equipmentType))})},loadPage(){x.loadDataService({}).then(e=>{this.picOptions=e.data,this.picOptions.length>0&&(this.name?this.row=this.picOptions.filter(e=>e.name===this.name)[0]:this.name=this.picOptions[0].name)})},initKonvaEdit(e){F=o.Node.create(e,"KonvaContainer0"),this.stage=F,S(F)},openDetail(){this.$vxeModal.show(T,{name:this.name},{width:window.innerWidth-100,title:`${this.name}详情`,height:window.innerHeight-100},{refresh:()=>{this.loadPage()}})},cellClickEvent({row:e}){console.log(e),"开关"===e.equipmentType&&function(e,t,n=1.2,a=500,i=1.01,r=!0,l=60){if(!e||"Stage"!==e.getClassName()||!t)return console.error("未提供有效的 Konva Stage 实例或 targetId。"),[];const s="konvaFlashAnimation";e.find("Group, Line, Rect, Ellipse, Path, Text").forEach(e=>{const t=e.getAttr(s);t&&(t.isRunning()&&t.stop(),e.setAttr(s,null)),e.opacity(1)});const d=(Array.isArray(t)?t.map(e=>String(e).trim()):String(t).split(",").map(e=>String(e).trim())).filter(Boolean);if(0===d.length)return[];let c=e.find("Group, Line, Rect, Ellipse, Path, Text").filter(e=>{const t=e.id();return!!t&&d.includes(String(t))});if(0===c.length)return console.warn(`未找到与 id: ${d.join(", ")} 关联的节点/线路。`),[];if(r){const t=[],n=e.find("Rect").filter(e=>"textBackground"!==e.name());c.forEach(e=>{const a=e.getClientRect(),i=a.x+a.width/2,o=a.y+a.height/2;let r=1/0,s=null;n.forEach(t=>{if(t===e)return;const n=t.getClientRect(),a=n.x+n.width/2,d=n.y+n.height/2,c=Math.sqrt(Math.pow(i-a,2)+Math.pow(o-d,2));c<r&&c<=l&&(r=c,s=t)}),s&&!c.includes(s)&&t.push(s)}),c=[...c,...t]}let f=1/0,h=1/0,p=-1/0,u=-1/0;c.forEach(t=>{const n=t.getClientRect({relativeTo:e});f=Math.min(f,n.x),h=Math.min(h,n.y),p=Math.max(p,n.x+n.width),u=Math.max(u,n.y+n.height)});const g=Math.max(1,p-f),m=Math.max(1,u-h),b=f+g/2,y=h+m/2,x=e.width(),w=e.height(),v=x/(g*n),k=w/(m*n);let C=Math.min(v,k);C=Math.min(Math.max(C,.1),i);const E=x/2-b*C,D=w/2-y*C;function S(e){const t=e.getAttr(s);t&&t.isRunning()&&t.stop();let n=0,i=!0;const r=new o.Animation(t=>{t&&t.time-n>a&&(i=!i,e.opacity(i?1:0),n=t.time)},e.getLayer());e.setAttr(s,r),r.start()}new o.Tween({node:e,duration:.8,x:E,y:D,scaleX:C,scaleY:C,easing:o.Easings.EaseInOut,onFinish:()=>{c.forEach(S),e.batchDraw()}}).play()}(F,e.jsonId)}}},[["render",function(e,t,n,a,i,o){const r=l("el-option"),u=l("el-select"),y=l("el-button"),x=l("el-date-picker"),w=l("vxe-column"),v=l("vxe-table");return s(),d("div",O,[c("header",null,[c("section",null,[c("div",P,[t[2]||(t[2]=p(" 图： ",-1)),f(u,{modelValue:i.name,"onUpdate:modelValue":t[0]||(t[0]=e=>i.name=e),placeholder:"请选择",clearable:"",style:{width:"300px"}},{default:h(()=>[(s(!0),d(g,null,m(i.picOptions,e=>(s(),b(r,{label:e.name,value:e.name},null,8,["label","value"]))),256))]),_:1},8,["modelValue"])])]),c("section",null,[f(y,{type:"gradientGreen",onClick:o.openDetail},{default:h(()=>[...t[3]||(t[3]=[p("查看详情",-1)])]),_:1},8,["onClick"])])]),t[5]||(t[5]=c("div",{class:"left"},[c("div",{id:"KonvaContainer0"})],-1)),c("div",N,[f(x,{modelValue:i.seatchParams.date,"onUpdate:modelValue":t[1]||(t[1]=e=>i.seatchParams.date=e),type:"datetime",placeholder:"选择日期时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm"},null,8,["modelValue"]),f(y,{onClick:o.getTable},{default:h(()=>[...t[4]||(t[4]=[p("查询",-1)])]),_:1},8,["onClick"]),f(v,{ref:"tableRef",data:i.tableData,stripe:"","keep-source":"",border:"",height:"100%",round:!0,resizable:"","row-config":{isHover:!0},align:"center",onCellClick:o.cellClickEvent},{default:h(()=>[f(w,{type:"expand",fixed:"left",width:"50"},{content:h(({row:e})=>[c("div",M,[f(v,{border:"",data:e.transformerPhaseDataList,"auto-resize":"",stripe:"","row-id":"id","row-config":{isHover:!0},round:!0,"keep-source":"",resizable:"",align:"center"},{default:h(()=>[f(w,{type:"seq",title:"序号",width:"60"}),f(w,{field:"equipmentName",title:"设备名称","min-width":"120"}),f(w,{field:"yg",title:"有功值",width:"120",sortable:""}),f(w,{field:"wg",title:"无功值",width:"120",sortable:""}),f(w,{field:"dl",title:"电流值",width:"120",sortable:""})]),_:1},8,["data"])])]),_:1}),f(w,{type:"seq",title:"序号",width:"60"}),f(w,{field:"substationName",title:"变电站名称","min-width":"120"}),f(w,{field:"equipmentName",title:"设备名称","min-width":"120"}),f(w,{field:"equipmentType",title:"设备类型",width:"120"}),f(w,{field:"belongSubstationName",title:"所属变电站","min-width":"120"}),f(w,{field:"statusDesc",title:"开关状态",width:"120"}),f(w,{field:"yg",title:"有功值",width:"110",sortable:"","header-align":"center",align:"right"}),f(w,{field:"wg",title:"无功值",width:"110",sortable:"","header-align":"center",align:"right"}),f(w,{field:"dl",title:"电流值",width:"110",sortable:"","header-align":"center",align:"right"})]),_:1},8,["data","onCellClick"])])])}],["__scopeId","data-v-e0e81125"]]))}}})}();
